<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨åˆ†æç³»ç»Ÿ - Web 1.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
        }

        .version-info {
            color: #6c757d;
            font-size: 14px;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
        }

        .config-btn, .logout-btn {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            color: #495057;
            font-size: 14px;
        }

        .logout-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            border-color: #dc3545;
            color: white;
        }

        .config-btn:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            transform: translateY(-2px);
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
            transform: translateY(-2px);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            min-height: 600px;
        }

        .left-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .right-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            margin-right: 4px;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .textarea {
            min-height: 120px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #4e9a2a 0%, #96d4b5 100%);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 2px solid #e9ecef;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background-color: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            margin: 16px 0;
            display: none;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            width: 0%;
        }

        .log-container {
            margin-top: 20px;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .log-header h3 {
            color: #495057;
            font-size: 16px;
        }

        .log-display {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            max-height: 250px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 4px;
            padding: 2px 0;
        }

        .log-info { color: #3498db; }
        .log-success { color: #27ae60; font-weight: bold; }
        .log-warning { color: #f39c12; font-weight: bold; }
        .log-error { color: #e74c3c; font-weight: bold; }
        .log-header-type { color: #667eea; font-weight: bold; font-size: 14px; }
        .log-progress { color: #9b59b6; font-weight: bold; }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-header h2 {
            color: #2c3e50;
            font-size: 20px;
        }

        .sse-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #6c757d;
        }

        .sse-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #dc3545;
            transition: background-color 0.3s;
        }

        .sse-indicator.connected {
            background: #28a745;
        }

        .score-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
            display: none;
        }

        .score-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            color: white;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .score-card.excellent { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); }
        .score-card.good { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .score-card.average { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .score-card.poor { background: linear-gradient(135deg, #ff4b2b 0%, #ff416c 100%); }

        .score-card.updating {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .score-card h4 {
            font-size: 12px;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .score-card .score {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .score-card .max-score {
            font-size: 10px;
            opacity: 0.8;
        }

        .data-quality {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
            display: none;
        }

        .quality-indicator {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .quality-indicator .value {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .quality-indicator .label {
            font-size: 10px;
            color: #6c757d;
        }

        .results-content {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
            overflow-y: auto;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: #6c757d;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e9ecef;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            color: #6c757d;
            padding: 60px 20px;
        }

        .empty-state h3 {
            margin-bottom: 8px;
        }

        .status-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .status-ready { background: #d4edda; color: #155724; }
        .status-analyzing { background: #d1ecf1; color: #0c5460; }
        .status-error { background: #f8d7da; color: #721c24; }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .score-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .ai-analysis-content {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .ai-analysis-content h1,
        .ai-analysis-content h2,
        .ai-analysis-content h3,
        .ai-analysis-content h4,
        .ai-analysis-content h5,
        .ai-analysis-content h6 {
            color: #2c3e50;
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .ai-analysis-content h1 { font-size: 1.5em; }
        .ai-analysis-content h2 { font-size: 1.3em; }
        .ai-analysis-content h3 { font-size: 1.1em; }

        .ai-analysis-content p {
            margin: 8px 0;
            line-height: 1.6;
        }

        .ai-analysis-content ul,
        .ai-analysis-content ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .ai-analysis-content li {
            margin: 4px 0;
            line-height: 1.5;
        }

        .ai-analysis-content strong {
            color: #1976d2;
            font-weight: 600;
        }

        .ai-analysis-content em {
            color: #f57c00;
            font-style: italic;
        }

        .ai-analysis-content code {
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            color: #d63384;
        }

        .ai-analysis-content blockquote {
            border-left: 4px solid #667eea;
            margin: 16px 0;
            padding: 8px 16px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 0 4px 4px 0;
        }

        .ai-analysis-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 16px 0;
        }

        .ai-analysis-content th,
        .ai-analysis-content td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }

        .ai-analysis-content th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .ai-analysis-content a {
            color: #1976d2;
            text-decoration: none;
        }

        .ai-analysis-content a:hover {
            text-decoration: underline;
        }

        @media (max-width: 640px) {
            .container {
                padding: 16px;
            }

            .header {
                padding: 16px;
            }

            .header h1 {
                font-size: 24px;
            }

            .header-info {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            .score-cards {
                grid-template-columns: 1fr;
            }

            .data-quality {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸš€ è‚¡ç¥¨åˆ†æç³»ç»Ÿ - Web V1.0</h1>
            <div class="header-info">
                <div class="version-info">
                    Web V1.0 | WebStockAnalyzer |  {% if auth_enabled %}| ğŸ” å·²è®¤è¯{% endif %}
                    <span id="systemStatus" class="status-indicator status-ready">ç³»ç»Ÿå°±ç»ª</span>
                </div>
                <div class="header-buttons">
                <a href="/" class="config-btn">ğŸ  é€‰è‚¡</a>
                <a href="/history" class="config-btn">ğŸ“š å†å²è®°å½•</a>
                <a href="/stock" class="config-btn">ğŸ“ˆ è‚¡ç¥¨åˆ†æ</a>
                {% if auth_enabled %}
                <a href="{{ url_for('logout') }}" class="logout-btn">ğŸšª é€€å‡ºç™»å½•</a>
                {% endif %}
            </div>
                <div class="header-buttons">
                    <button class="config-btn" onclick="showConfig()">âš™ï¸ AIé…ç½®</button>
                    {% if auth_enabled %}
                    <a href="{{ url_for('logout') }}" class="logout-btn">ğŸšª é€€å‡ºç™»å½•</a>
                    {% endif %}
                </div>
            </div>

        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Panel - Input and Controls -->
            <div class="left-panel">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('single')">ğŸ“ˆ å•åªåˆ†æ</button>
                    <button class="tab" onclick="switchTab('batch')">ğŸ“Š æ‰¹é‡åˆ†æ</button>
                    <button class="tab" onclick="switchTab('select')">ğŸ“Š è‚¡ç¥¨ç­›é€‰</button>
                </div>
                <!-- Single Stock Analysis -->
                <div id="singleTab" class="tab-content active" >
                    <div class="form-group"  style="display: flex; align-items: center; width: 280px; height: 60px;">
                        <label for="stockCode" style="width: 80px; margin-right: 10px;">è‚¡ç¥¨ä»£ç </label>
                        <input type="text" id="stockCode"   style="width: 120px;flex: 1; height: 30px; padding: 5px;" class="form-control"
                               placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç ï¼ˆå¦‚ï¼š000001ã€600036ã€300019ï¼‰">
                    </div>

                     <div class="form-group" style="display: flex; align-items: center; width: 280px; height: 60px;">
                        <label for="market" style="width: 80px; margin-right: 10px;">è‚¡ç¥¨å¸‚åœº</label>
                        <select id="market" name="market" style="width: 120px;flex: 1; height: 30px; padding: 5px;">
                            <option value="SH" {% if market == 'SH' %}selected{% endif %}>ä¸Šæµ·</option>
                            <option value="SZ" {% if market == 'SZ' %}selected{% endif %}>æ·±åœ³</option>
                            <option value="usa" {% if market == 'usa' %}selected{% endif %}>ç¾å›½</option>
                            <option value="H" {% if market == 'H' %}selected{% endif %}>é¦™æ¸¯</option>
                            <option value="zq" {% if market == 'zq' %}selected{% endif %}>å€ºåˆ¸</option>
                            <option value="cy" {% if market == 'cy' %}selected{% endif %}>åˆ›ä¸šæ¿</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="enableStreaming" checked>
                            <label for="enableStreaming">å¯ç”¨æµå¼æ¨ç†æ˜¾ç¤º</label>
                        </div>
                    </div>

                    <button id="analyzeBtn" class="btn btn-primary" onclick="analyzeSingleStock()">
                        ğŸ” å¼€å§‹æ·±åº¦åˆ†æ
                    </button>

                    <div id="singleProgress" class="progress-bar">
                        <div class="progress-bar-fill"></div>
                    </div>
                </div>

                <!-- Batch Analysis -->
                <div id="batchTab" class="tab-content">
                    <div class="form-group">
                        <label for="stockList">è‚¡ç¥¨ä»£ç åˆ—è¡¨</label>
                        <textarea id="stockList" class="form-control textarea"
                                  placeholder="è¾“å…¥å¤šä¸ªè‚¡ç¥¨ä»£ç ï¼Œæ¯è¡Œä¸€ä¸ª&#10;ä¾‹å¦‚ï¼š&#10;000001&#10;000002&#10;600036&#10;300019"></textarea>
                    </div>

                    <button id="batchAnalyzeBtn" class="btn btn-success" onclick="analyzeBatchStocks()">
                        ğŸ“Š æ‰¹é‡æ·±åº¦åˆ†æ
                    </button>

                    <div id="batchProgress" class="progress-bar">
                        <div class="progress-bar-fill"></div>
                    </div>

                    <div id="currentStock" style="display: none; margin-top: 12px; color: #6c757d; font-size: 12px; font-style: italic;"></div>
                </div>


                <div id="selectTab" class="tab-content">

                    <div class="form-group" style="display: flex; align-items: center; width: 280px; height: 60px;">
                        <label for="market" style="width: 80px; margin-right: 10px;">è‚¡ç¥¨å¸‚åœº</label>
                        <select id="market" name="market" style="width: 120px;flex: 1; height: 30px; padding: 5px;">
                            <option value="SH" {% if market == 'SH' %}selected{% endif %}>ä¸Šæµ·</option>
                            <option value="SZ" {% if market == 'SZ' %}selected{% endif %}>æ·±åœ³</option>
                            <option value="usa" {% if market == 'usa' %}selected{% endif %}>ç¾å›½</option>
                            <option value="H" {% if market == 'H' %}selected{% endif %}>é¦™æ¸¯</option>
                            <option value="zq" {% if market == 'zq' %}selected{% endif %}>å€ºåˆ¸</option>
                            <option value="cy" {% if market == 'cy' %}selected{% endif %}>åˆ›ä¸šæ¿</option>
                        </select>
                    </div>

                    <div class="form-group" style="display: flex; align-items: center; width: 280px; height: 60px;">
                        <label for="strategy" style="width: 80px; margin-right: 10px;">ç­›é€‰ç­–ç•¥</label>
                        <select id="strategy" name="strategy" style="width: 120px;flex: 1; height: 30px; padding: 5px;">
                            <option value="1" {% if strategy == '1' %}selected{% endif %}>é«˜è‚¡æ¯æŠ•èµ„ç­–ç•¥</option>
                            <option value="2" {% if strategy == '2' %}selected{% endif %}>ä¼˜è´¨è‚¡ç­›é€‰ç­–ç•¥</option>
                            <option value="3" {% if strategy == '3' %}selected{% endif %}>ä¿å®ˆå‹ç­›é€‰ç­–ç•¥</option>
                            <option value="4" {% if strategy == '4' %}selected{% endif %}>æˆé•¿å‹ç­›é€‰ç­–ç•¥</option>
                            <option value="5" {% if strategy == '5' %}selected{% endif %}>ä»·å€¼å‹ç­›é€‰ç­–ç•¥</option>
                            <option value="6" {% if strategy == '6' %}selected{% endif %}>çŸ¥åè‚¡ç¥¨ç­›é€‰</option>
                        </select>
                    </div>

                    <button id="selectBtn" class="btn btn-primary" onclick="analyzeSelectStock()">
                        ğŸ” å¼€å§‹ç­›é€‰
                    </button>

                    <div id="selectProgress" class="progress-bar">
                        <div class="progress-bar-fill"></div>
                    </div>

                </div>


                <!-- Log Container -->
                <div class="log-container">
                    <div class="log-header">
                        <h3>ğŸ“‹ åˆ†ææ—¥å¿—</h3>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <div class="sse-status">
                                <div id="sseIndicator" class="sse-indicator"></div>
                                <span id="sseStatus">SSEæ–­å¼€</span>
                            </div>
                            <button class="btn btn-secondary" onclick="clearLog()" style="padding: 4px 12px; font-size: 12px;">
                                ğŸ—‘ï¸ æ¸…ç©º
                            </button>
                        </div>
                    </div>
                    <div id="logDisplay" class="log-display">
                        <div class="log-entry log-info">ğŸ“‹ ç³»ç»Ÿå°±ç»ªï¼Œç­‰å¾…åˆ†æä»»åŠ¡...</div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Results -->
            <div class="right-panel">
                <div class="results-header">
                    <h2>ğŸ“‹ åˆ†æç»“æœ</h2>
                    <button id="exportBtn" class="btn btn-secondary" onclick="exportReport()" style="display: none;">
                        ğŸ“¤ å¯¼å‡ºæŠ¥å‘Š
                    </button>
                </div>

                <!-- Score Cards -->
                <div id="scoreCards" class="score-cards">
                    <div class="score-card" id="comprehensiveCard">
                        <h4>ç»¼åˆå¾—åˆ†</h4>
                        <div class="score">--</div>
                        <div class="max-score">/100</div>
                    </div>
                    <div class="score-card" id="technicalCard">
                        <h4>æŠ€æœ¯åˆ†æ</h4>
                        <div class="score">--</div>
                        <div class="max-score">/100</div>
                    </div>
                    <div class="score-card" id="fundamentalCard">
                        <h4>åŸºæœ¬é¢</h4>
                        <div class="score">--</div>
                        <div class="max-score">/100</div>
                    </div>
                    <div class="score-card" id="sentimentCard">
                        <h4>å¸‚åœºæƒ…ç»ª</h4>
                        <div class="score">--</div>
                        <div class="max-score">/100</div>
                    </div>
                </div>

                <!-- Data Quality Indicators -->
                <div id="dataQuality" class="data-quality">
                    <div class="quality-indicator">
                        <div id="financialCount" class="value">--</div>
                        <div class="label">è´¢åŠ¡æŒ‡æ ‡</div>
                    </div>
                    <div class="quality-indicator">
                        <div id="newsCount" class="value">--</div>
                        <div class="label">æ–°é—»æ•°æ®</div>
                    </div>
                    <div class="quality-indicator">
                        <div id="completeness" class="value">--</div>
                        <div class="label">å®Œæ•´åº¦</div>
                    </div>
                </div>

                <!-- Results Content -->
                <div id="resultsContent" class="results-content">
                    <div class="empty-state">
                        <h3>ğŸ“Š ç­‰å¾…åˆ†æ</h3>
                        <p>è¯·åœ¨å·¦ä¾§è¾“å…¥è‚¡ç¥¨ä»£ç å¹¶å¼€å§‹åˆ†æ</p>
                        <p style="margin-top: 8px; font-size: 12px; color: #9ba2ab;">ğŸŒŠ æ”¯æŒSSEå®æ—¶æ¨é€</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ marked.jsç”¨äºmarkdownè§£æ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>

    <script>
        // Global variables
        let currentAnalysis = null;
        let isAnalyzing = false;
        let sseConnection = null;
        let currentClientId = null;
        const API_BASE = '';  // Flask server base URL

        // é…ç½®marked.js
        if (typeof marked !== 'undefined') {
            marked.setOptions({
                breaks: true,
                gfm: true,
                sanitize: false,
                smartLists: true,
                smartypants: true
            });
        }

        // SSEè¿æ¥ç®¡ç†
        function initSSE() {
            if (sseConnection) {
                sseConnection.close();
            }

            currentClientId = generateClientId();
            const sseUrl = `${API_BASE}/api/sse?client_id=${currentClientId}`;

            addLog('ğŸŒŠ æ­£åœ¨å»ºç«‹SSEè¿æ¥...', 'info');

            sseConnection = new EventSource(sseUrl);

            sseConnection.onopen = function(event) {
                addLog('âœ… SSEè¿æ¥å·²å»ºç«‹', 'success');
                updateSSEStatus(true);
            };

            sseConnection.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleSSEMessage(data);
                } catch (e) {
                    console.error('SSEæ¶ˆæ¯è§£æå¤±è´¥:', e);
                }
            };

            sseConnection.onerror = function(event) {
                addLog('âŒ SSEè¿æ¥é”™è¯¯', 'error');
                updateSSEStatus(false);

                // è‡ªåŠ¨é‡è¿
                setTimeout(() => {
                    if (!sseConnection || sseConnection.readyState === EventSource.CLOSED) {
                        addLog('ğŸ”„ å°è¯•é‡æ–°è¿æ¥SSE...', 'warning');
                        initSSE();
                    }
                }, 3000);
            };

            sseConnection.onclose = function(event) {
                addLog('ğŸ”Œ SSEè¿æ¥å·²å…³é—­', 'warning');
                updateSSEStatus(false);
            };
        }

        function generateClientId() {
            return 'client_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }

        function updateSSEStatus(connected) {
            const indicator = document.getElementById('sseIndicator');
            const status = document.getElementById('sseStatus');

            if (connected) {
                indicator.classList.add('connected');
                status.textContent = 'SSEå·²è¿æ¥';
            } else {
                indicator.classList.remove('connected');
                status.textContent = 'SSEæ–­å¼€';
            }
        }

        function handleSSEMessage(data) {
            const eventType = data.event;
            const eventData = data.data;

            switch (eventType) {
                case 'log':
                    addLog(eventData.message, eventData.type || 'info');
                    break;

                case 'progress':
                    updateProgress(eventData.element_id, eventData.percent);
                    if (eventData.message) {
                        addLog(eventData.message, 'progress');
                    }
                    if (eventData.current_stock) {
                        document.getElementById('currentStock').textContent =
                            `æ­£åœ¨åˆ†æ: ${eventData.current_stock}`;
                        document.getElementById('currentStock').style.display = 'block';
                    }
                    break;

                case 'scores_update':
                    updateScoreCards(eventData.scores);
                    if (eventData.animate) {
                        animateScoreCards();
                    }
                    break;

                case 'data_quality_update':
                    updateDataQuality(eventData);
                    break;

                case 'partial_result':
                    displayPartialResults(eventData);
                    break;

                case 'final_result':
                    displayResults(eventData);
                    currentAnalysis = eventData;
                    break;

                case 'batch_result':
                    displayBatchResults(eventData);
                    currentAnalysis = eventData;
                    break;
                case 'select_result':
                    displaySelectResults(eventData);
                    currentAnalysis = eventData;
                    break;

                case 'analysis_complete':
                    onAnalysisComplete(eventData);
                    break;


                case 'analysis_error':
                    onAnalysisError(eventData);
                    break;

                case 'ai_stream':
                    handleAIStream(eventData);
                    break;

                case 'error':
                    addLog(`âš ï¸ SSEé”™è¯¯: ${eventData.error || 'æœªçŸ¥é”™è¯¯'}`, 'warning');
                    break;

                case 'heartbeat':
                    // å¿ƒè·³ï¼Œä¸éœ€è¦å¤„ç†
                    break;

                default:
                    console.log('æœªçŸ¥SSEäº‹ä»¶:', eventType, eventData);
            }
        }

        function handleAIStream(data) {
            // è·å–æˆ–åˆ›å»ºAIæµå¼æ˜¾ç¤ºåŒºåŸŸ
            let aiStreamDiv = document.getElementById('aiStreamContent');
            if (!aiStreamDiv) {
                // åœ¨ç»“æœåŒºåŸŸä¸­æŸ¥æ‰¾AIåˆ†æéƒ¨åˆ†
                const resultsContent = document.getElementById('resultsContent');
                const aiSection = resultsContent.querySelector('.ai-analysis-content');

                if (aiSection) {
                    // å¦‚æœæ‰¾åˆ°äº†AIåˆ†æéƒ¨åˆ†ï¼Œåˆ›å»ºæµå¼å†…å®¹åŒºåŸŸ
                    aiStreamDiv = document.createElement('div');
                    aiStreamDiv.id = 'aiStreamContent';
                    aiStreamDiv.style.cssText = `
                        border: 2px solid #ff9800;
                        border-radius: 8px;
                        padding: 16px;
                        margin: 16px 0;
                        background: rgba(255, 152, 0, 0.1);
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        line-height: 1.6;
                        min-height: 100px;
                        white-space: pre-wrap;
                        word-wrap: break-word;
                    `;

                    // æ·»åŠ æµå¼æ ‡é¢˜
                    const streamTitle = document.createElement('h3');
                    streamTitle.textContent = 'ğŸ¤– AI æ·±åº¦åˆ†æ - å®æ—¶ç”Ÿæˆä¸­...';
                    streamTitle.style.cssText = 'color: #f57c00; margin-bottom: 12px; font-size: 16px;';

                    const streamContainer = document.createElement('div');
                    streamContainer.appendChild(streamTitle);
                    streamContainer.appendChild(aiStreamDiv);

                    // æ’å…¥åˆ°ç»“æœåŒºåŸŸ
                    resultsContent.appendChild(streamContainer);
                } else {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç»“æœåŒºåŸŸï¼Œåˆ›å»ºä¸´æ—¶æ˜¾ç¤ºåŒºåŸŸ
                    const resultsContent = document.getElementById('resultsContent');
                    resultsContent.innerHTML = `
                        <div style="line-height: 1.6;">
                            <h2 style="color: #2c3e50; border-bottom: 2px solid #e9ecef; padding-bottom: 12px; margin-bottom: 20px;">
                                ğŸ“ˆ å®æ—¶åˆ†æè¿›è¡Œä¸­...
                                <span style="font-size: 12px; color: #28a745; font-weight: normal;">ğŸŒŠ AIæµå¼ç”Ÿæˆä¸­</span>
                            </h2>

                            <div style="background: #fff3e0; padding: 20px; border-radius: 8px; border-left: 4px solid #ff9800;">
                                <h3 style="color: #f57c00; margin-bottom: 12px;">ğŸ¤– AI æ·±åº¦åˆ†æ - å®æ—¶ç”Ÿæˆä¸­...</h3>
                                <div id="aiStreamContent" style="color: #5d4037; font-size: 14px; line-height: 1.7; white-space: pre-wrap; word-wrap: break-word;"></div>
                            </div>
                        </div>
                    `;
                    aiStreamDiv = document.getElementById('aiStreamContent');
                }
            }

            // æ·»åŠ AIæµå¼å†…å®¹
            if (aiStreamDiv && data.content) {
                aiStreamDiv.textContent += data.content;

                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                aiStreamDiv.scrollTop = aiStreamDiv.scrollHeight;

                // å¦‚æœå®¹å™¨å¯è§ï¼Œä¹Ÿæ»šåŠ¨åˆ°åº•éƒ¨
                const resultsContent = document.getElementById('resultsContent');
                if (resultsContent) {
                    resultsContent.scrollTop = resultsContent.scrollHeight;
                }
            }
        }

        function animateScoreCards() {
            const cards = document.querySelectorAll('.score-card');
            cards.forEach(card => {
                card.classList.add('updating');
                setTimeout(() => {
                    card.classList.remove('updating');
                }, 1500);
            });
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // Log functions
        function addLog(message, type = 'info') {
            const logDisplay = document.getElementById('logDisplay');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;

            const timestamp = new Date().toLocaleTimeString();
            let icon = 'ğŸ“‹';

            switch(type) {
                case 'success': icon = 'âœ…'; break;
                case 'warning': icon = 'âš ï¸'; break;
                case 'error': icon = 'âŒ'; break;
                case 'header': icon = 'ğŸ¯'; break;
                case 'progress': icon = 'ğŸ”„'; break;
            }

            logEntry.innerHTML = `<span style="color: #999;">[${timestamp}]</span> ${icon} ${message}`;
            logDisplay.appendChild(logEntry);
            logDisplay.scrollTop = logDisplay.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logDisplay').innerHTML =
                '<div class="log-entry log-info">ğŸ“‹ æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        // Progress bar functions
        function showProgress(elementId, show = true) {
            const progressBar = document.getElementById(elementId);
            progressBar.style.display = show ? 'block' : 'none';
            if (!show) {
                progressBar.querySelector('.progress-bar-fill').style.width = '0%';
            }
        }

        function updateProgress(elementId, percent) {
            const fill = document.getElementById(elementId).querySelector('.progress-bar-fill');
            fill.style.width = percent + '%';
        }

        // Score card functions
        function updateScoreCards(scores) {
            const cards = {
                comprehensive: document.getElementById('comprehensiveCard'),
                technical: document.getElementById('technicalCard'),
                fundamental: document.getElementById('fundamentalCard'),
                sentiment: document.getElementById('sentimentCard')
            };

            Object.keys(scores).forEach(key => {
                const card = cards[key];
                if (card) {
                    const score = scores[key];
                    card.querySelector('.score').textContent = score.toFixed(1);

                    card.className = 'score-card';
                    if (score >= 80) card.classList.add('excellent');
                    else if (score >= 60) card.classList.add('good');
                    else if (score >= 40) card.classList.add('average');
                    else card.classList.add('poor');
                }
            });

            document.getElementById('scoreCards').style.display = 'grid';
        }

        function updateDataQuality(data) {
            document.getElementById('financialCount').textContent =
                data.financial_indicators_count || 0;
            document.getElementById('newsCount').textContent =
                data.total_news_count || 0;
            document.getElementById('completeness').textContent =
                (data.analysis_completeness || 'éƒ¨åˆ†').substring(0, 2);

            document.getElementById('dataQuality').style.display = 'grid';
        }

        // Results display
        function showLoading() {
            document.getElementById('resultsContent').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>æ­£åœ¨è¿›è¡Œæ·±åº¦åˆ†æ...</p>
                    <p style="font-size: 12px; color: #9ba2ab;">ğŸŒŠ å®æ—¶æµå¼æ¨é€ä¸­</p>
                </div>
            `;
        }

        function displayPartialResults(data) {
            // æ˜¾ç¤ºéƒ¨åˆ†ç»“æœï¼Œæ¯”å¦‚åŸºæœ¬ä¿¡æ¯
            const resultsContent = document.getElementById('resultsContent');

            if (data.type === 'basic_info') {
                resultsContent.innerHTML = `
                    <div style="line-height: 1.6;">
                        <h2 style="color: #2c3e50; border-bottom: 2px solid #e9ecef; padding-bottom: 12px; margin-bottom: 20px;">
                            ğŸ“ˆ ${data.stock_name || data.stock_code} åˆ†ææŠ¥å‘Š
                            <span style="font-size: 12px; color: #6c757d; font-weight: normal;">ğŸŒŠ å®æ—¶æµå¼åˆ†æä¸­...</span>
                        </h2>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px;">
                                <h4 style="color: #495057; margin-bottom: 8px;">åŸºæœ¬ä¿¡æ¯</h4>
                                <p><strong>è‚¡ç¥¨ä»£ç :</strong> ${data.stock_code}</p>
                                <p><strong>å½“å‰ä»·æ ¼:</strong> Â¥${(data.current_price || 0).toFixed(2)}</p>
                                <p><strong>æ¶¨è·Œå¹…:</strong> ${(data.price_change || 0).toFixed(2)}%</p>
                            </div>

                            <div style="background: #e3f2fd; padding: 16px; border-radius: 8px;">
                                <h4 style="color: #495057; margin-bottom: 8px;">åˆ†æè¿›åº¦</h4>
                                <p>ğŸ”„ æ­£åœ¨è·å–æŠ€æœ¯æŒ‡æ ‡...</p>
                                <p>â³ æ­£åœ¨åˆ†æè´¢åŠ¡æ•°æ®...</p>
                                <p>ğŸŒŠ æ­£åœ¨å¤„ç†æ–°é—»æƒ…ç»ª...</p>
                            </div>
                        </div>

                        <div style="background: #fff3e0; padding: 20px; border-radius: 8px; border-left: 4px solid #ff9800;">
                            <h3 style="color: #f57c00; margin-bottom: 12px;">ğŸ¤– AI æ·±åº¦åˆ†æè¿›è¡Œä¸­</h3>
                            <div style="color: #5d4037; font-size: 14px; line-height: 1.7;">
                                æ­£åœ¨æ”¶é›†æ•°æ®å¹¶è¿›è¡ŒAIæ™ºèƒ½åˆ†æï¼Œè¯·ç¨å€™...
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function displaySelectResults(data) {
            const resultsContent = document.getElementById('resultsContent');

            if (data.success === true) {
                addLog('ç­›é€‰åˆ†æç»“æœè¿”å›æˆåŠŸ', 'success');


                // è§£æå„ä¸ªåˆ†æå†…å®¹
                const high_score_text = marked.parse(data.high_score_text);
                const summary_text = marked.parse(data.summary_text);
                const all_results = marked.parse(data.all_results);

                addLog('ç­›é€‰åˆ†æç»“æœè§£ææ­£å¸¸', 'info');

                // æ„å»ºTabé¡µé¢ç»“æ„
                resultsContent.innerHTML = `
                    <style>
                        .table-container {
                            overflow-x: auto;
                            margin: 20px 0;
                            border-radius: 8px;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        }
                        .md-content table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 16px 0;
                            min-width: 800px;
                        }
                        .md-content th,
                        .md-content td {
                            border: 1px solid #ddd;
                            padding: 12px 15px;
                            text-align: left;
                            white-space: nowrap;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            max-width: 250px;
                        }
                        .md-content th {
                            background-color: #f8f9fa;
                            font-weight: 600;
                            color: #495057;
                            position: sticky;
                            top: 0;
                        }
                        .md-content td.long-content {
                            white-space: normal;
                            word-wrap: break-word;
                            max-width: 300px;
                        }
                    </style>
                    <!-- Tabå¯¼èˆªæ  -->
                    <div class="tab-container">
                       <div class="tabs">
                            <button class="tab-btn active" data-tab="recommend-info">æ¨èè‚¡ç¥¨ç»“æœ</button>
                            <button class="tab-btn" data-tab="recommend-analysis">æ¨èè‚¡ç¥¨ä¿¡æ¯</button>
                            <button class="tab-btn" data-tab="basic-analysis">è‚¡ç¥¨è®¡ç®—ä¿¡æ¯</button>

                        </div>

                        <!-- Tabå†…å®¹åŒºåŸŸ -->
                        <div class="tab-contents">
                            <!-- æ¨èè‚¡ç¥¨ç»“æœ -->
                            <div class="tab-content active" id="recommend-info">
                                <div class="md-content">${high_score_text}</div>
                            </div>

                            <!-- æ¨èè‚¡ç¥¨ä¿¡æ¯ -->
                            <div class="tab-content" id="recommend-analysis">
                                <div class="md-content">${summary_text}</div>
                            </div>

                            <!-- è‚¡ç¥¨è®¡ç®—ä¿¡æ¯ -->
                            <div class="tab-content" id="basic-analysis">
                                <div class="md-content">${all_results}</div>
                            </div>
                        </div>
                    </div>
                `;

                // æ·»åŠ Tabåˆ‡æ¢åŠŸèƒ½
                const tabButtons = document.querySelectorAll('.tab-btn');
                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        // ç§»é™¤æ‰€æœ‰TabæŒ‰é’®çš„activeç±»
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        // ç»™å½“å‰ç‚¹å‡»çš„æŒ‰é’®æ·»åŠ activeç±»
                        button.classList.add('active');

                        // éšè—æ‰€æœ‰Tabå†…å®¹
                        const tabContents = document.querySelectorAll('.tab-content');
                        tabContents.forEach(content => content.classList.remove('active'));

                        // æ˜¾ç¤ºå¯¹åº”çš„Tabå†…å®¹
                        const tabId = button.getAttribute('data-tab');
                        document.getElementById(tabId).classList.add('active');
                    });
                });

                addLog('æœåŠ¡åº¦åˆ†æèµ‹å€¼å®Œæˆ-Tab ', 'info');
            } else {
                addLog('åˆ†æç»“æœè¿”å›é”™è¯¯', 'warning');
                resultsContent.innerHTML = `
                    <h2>å¤„ç†å‡ºé”™ </h2>
                    <div class="md-content" id="error-info">${JSON.stringify(data)}</div>
                `;
            }

            document.getElementById('exportBtn').style.display = 'inline-flex';
            addLog('åˆ†ææ‰§è¡Œå®Œæ¯•', 'success');
        }


        function displayResults(data) {
            const resultsContent = document.getElementById('resultsContent');

            if (data.success === true) {
                addLog('æœåŠ¡åº¦åˆ†æç»“æœè¿”å›æˆåŠŸ', 'success');
                const tec_score = data.tec_score;
                const sentiment_score = data.sentiment_score;
                const image_paths = data.image_paths;

                // è§£æå„ä¸ªåˆ†æå†…å®¹
                const stock_summary = marked.parse(data.stock_summary);
                const stock_analysis_result = marked.parse(data.stock_analysis_result);
                const annual_report_analysis = marked.parse(data.annual_report_analysis);
                const sentiment_analysis = marked.parse(data.sentiment_analysis);
                const tec_data_analysis = marked.parse(data.tec_data_analysis);

                const fundamental_analysis = marked.parse(data.fundamental_analysis);

                addLog('æœåŠ¡åº¦åˆ†æç»“æœè§£ææ­£å¸¸', 'info');

                // æ„å»ºTabé¡µé¢ç»“æ„
                resultsContent.innerHTML = `
                    <!-- Tabå¯¼èˆªæ  -->
                    <div class="tab-container">
                       <div class="tabs">
                            <button class="tab-btn active" data-tab="basic-info">å…¬å¸åŸºæœ¬æƒ…å†µ</button>
                            <button class="tab-btn" data-tab="tech-analysis">è‚¡ç¥¨æŠ€æœ¯é¢åˆ†æ</button>
                            <button class="tab-btn" data-tab="fundamental-analysis">å…¬å¸åŸºæœ¬é¢æŠ€æœ¯åˆ†æ</button>
                            <button class="tab-btn" data-tab="annual-report">å…¬å¸å¹´æŠ¥åˆ†æ</button>
                            <button class="tab-btn" data-tab="sentiment-analysis">å…¬å¸æƒ…ç»ªåˆ†æ</button>
                        </div>

                        <!-- Tabå†…å®¹åŒºåŸŸ -->
                        <div class="tab-contents">
                            <!-- å…¬å¸åŸºæœ¬æƒ…å†µ -->
                            <div class="tab-content active" id="basic-info">
                                <div class="md-content">${stock_summary}</div>
                            </div>

                            <!-- è‚¡ç¥¨æŠ€æœ¯é¢åˆ†æ -->
                            <div class="tab-content" id="tech-analysis">
                                <div class="md-content">${tec_data_analysis}</div>
                            </div>

                            <!-- å…¬å¸åŸºæœ¬é¢åˆ†æ -->
                            <div class="tab-content" id="fundamental-analysis">
                                <div class="md-content">${fundamental_analysis}</div>
                            </div>

                            <!-- å…¬å¸å¹´æŠ¥åˆ†æ -->
                            <div class="tab-content" id="annual-report">
                                <div class="md-content">${annual_report_analysis}</div>
                            </div>

                            <!-- å…¬å¸æƒ…ç»ªåˆ†æ -->
                            <div class="tab-content" id="sentiment-analysis">
                                <div class="md-content">${sentiment_analysis}</div>
                            </div>
                        </div>
                    </div>
                `;

                // æ·»åŠ Tabåˆ‡æ¢åŠŸèƒ½
                const tabButtons = document.querySelectorAll('.tab-btn');
                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        // ç§»é™¤æ‰€æœ‰TabæŒ‰é’®çš„activeç±»
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        // ç»™å½“å‰ç‚¹å‡»çš„æŒ‰é’®æ·»åŠ activeç±»
                        button.classList.add('active');

                        // éšè—æ‰€æœ‰Tabå†…å®¹
                        const tabContents = document.querySelectorAll('.tab-content');
                        tabContents.forEach(content => content.classList.remove('active'));

                        // æ˜¾ç¤ºå¯¹åº”çš„Tabå†…å®¹
                        const tabId = button.getAttribute('data-tab');
                        document.getElementById(tabId).classList.add('active');
                    });
                });

                addLog('æœåŠ¡åº¦åˆ†æèµ‹å€¼å®Œæˆ-Tab ', 'info');
            } else {
                addLog('åˆ†æç»“æœè¿”å›é”™è¯¯', 'warning');
                resultsContent.innerHTML = `
                    <h2>å¤„ç†å‡ºé”™ </h2>
                    <div class="md-content" id="error-info">${JSON.stringify(data)}</div>
                `;
            }

            document.getElementById('exportBtn').style.display = 'inline-flex';
            addLog('åˆ†ææ‰§è¡Œå®Œæ¯•', 'success');
        }


        function displayResults_v1(data) {
            const resultsContent = document.getElementById('resultsContent');
            // ä¿®æ­£å¸ƒå°”å€¼æ¯”è¾ƒ
            if (data.success === true) {
                addLog('æœåŠ¡åº¦åˆ†æç»“æœè¿”å›æˆåŠŸ', 'success');
                const tec_score = data.tec_score;
                const sentiment_score = data.sentiment_score;
                const image_paths = data.image_paths;

                // ä¿®æ­£å˜é‡årdataä¸ºdata
                const stock_summary = marked.parse(data.stock_summary);
                const stock_analysis_result = marked.parse(data.stock_analysis_result);
                const annual_report_analysis = marked.parse(data.annual_report_analysis);
                const sentiment_analysis = marked.parse(data.sentiment_analysis);
                const tec_data_analysis = marked.parse(data.tec_data_analysis);
                // ç¡®ä¿ä½¿ç”¨çš„å˜é‡éƒ½å·²å®šä¹‰
                const fundamental_analysis = marked.parse(data.fundamental_analysis);

                addLog('æœåŠ¡åº¦åˆ†æç»“æœè§£ææ­£å¸¸', 'info');
                // ä½¿ç”¨æ¨¡æ¿å­—ç¬¦ä¸²å’Œæ­£ç¡®çš„å˜é‡å¼•ç”¨
                resultsContent.innerHTML = `
                    <h2>å…¬å¸åŸºæœ¬æƒ…å†µ</h2>
                    <div class="md-content" id="stock-summary">${stock_summary}</div>

                    <h2>è‚¡ç¥¨æŠ€æœ¯é¢åˆ†æ</h2>
                    <div class="md-content" id="tec-analysis">${tec_data_analysis}</div>

                    <h2>å…¬å¸åŸºæœ¬é¢åˆ†æç»“æœ</h2>
                    <div class="md-content" id="fundamental-analysis">${fundamental_analysis}</div>

                    <h2>å…¬å¸å¹´æŠ¥åˆ†æ</h2>
                    <div class="md-content" id="annual-report-analysis">${annual_report_analysis}</div>

                    <h2>å…¬å¸æƒ…ç»ªåˆ†æ</h2>
                    <div class="md-content" id="sentiment-analysis">${sentiment_analysis}</div>
                `;
                addLog('æœåŠ¡åº¦åˆ†æèµ‹å€¼å®Œæˆ ', 'info');
            } else {
                addLog('åˆ†æç»“æœè¿”å›é”™è¯¯', 'warning');
                resultsContent.innerHTML = `
                    <h2>å¤„ç†å‡ºé”™ </h2>
                    <div class="md-content" id="error-info">${JSON.stringify(data)}</div>
                `;
            }

            // ç§»é™¤æœªå®šä¹‰çš„htmlå˜é‡å¼•ç”¨
            document.getElementById('exportBtn').style.display = 'inline-flex';
            addLog('åˆ†ææ‰§è¡Œå®Œæ¯•', 'success');
        }

        function displayResults_old(report) {
            const resultsContent = document.getElementById('resultsContent');

            // æ£€æŸ¥æ˜¯å¦æœ‰AIæµå¼å†…å®¹æ­£åœ¨æ˜¾ç¤º
            const existingAIStream = document.getElementById('aiStreamContent');
            let aiAnalysisHtml = '';

            if (existingAIStream && existingAIStream.textContent.trim()) {
                // å¦‚æœæœ‰æµå¼å†…å®¹ï¼Œä½¿ç”¨æµå¼å†…å®¹å¹¶æ ‡è®°ä¸ºå®Œæˆ
                const streamTitle = existingAIStream.parentElement.querySelector('h3');
                if (streamTitle) {
                    streamTitle.innerHTML = 'ğŸ¤– AI æ·±åº¦åˆ†æ <span style="color: #28a745; font-size: 12px;">âœ… ç”Ÿæˆå®Œæˆ</span>';
                }

                // å°†æµå¼å†…å®¹è½¬æ¢ä¸ºmarkdownæ ¼å¼
                const streamContent = existingAIStream.textContent;
                if (typeof marked !== 'undefined') {
                    aiAnalysisHtml = marked.parse(streamContent);
                } else {
                    aiAnalysisHtml = simpleMarkdownParse(streamContent);
                }

                // æ›´æ–°AIåˆ†æåŒºåŸŸ
                existingAIStream.innerHTML = aiAnalysisHtml;
                existingAIStream.classList.add('ai-analysis-content');
                existingAIStream.style.whiteSpace = 'normal';

                // ä¿ç•™ç°æœ‰çš„å®Œæ•´ç»“æœï¼Œåªæ›´æ–°å…¶ä»–éƒ¨åˆ†
                updateNonAIContent(report);
                return;
            }

            // å¤„ç†AIåˆ†æçš„markdownå†…å®¹ï¼ˆå¦‚æœæ²¡æœ‰æµå¼å†…å®¹ï¼‰
            if (report.ai_analysis) {
                if (typeof marked !== 'undefined') {
                    aiAnalysisHtml = marked.parse(report.ai_analysis);
                } else {
                    aiAnalysisHtml = simpleMarkdownParse(report.ai_analysis);
                }
            } else {
                aiAnalysisHtml = '<p>åˆ†ææ•°æ®å‡†å¤‡ä¸­...</p>';
            }

            const html = `
                <div style="line-height: 1.6;">
                    <h2 style="color: #2c3e50; border-bottom: 2px solid #e9ecef; padding-bottom: 12px; margin-bottom: 20px;">
                        ğŸ“ˆ ${report.stock_name || report.stock_code} åˆ†ææŠ¥å‘Š
                        <span style="font-size: 12px; color: #28a745; font-weight: normal;">âœ… æµå¼åˆ†æå®Œæˆ</span>
                    </h2>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px;">
                            <h4 style="color: #495057; margin-bottom: 8px;">åŸºæœ¬ä¿¡æ¯</h4>
                            <p><strong>è‚¡ç¥¨ä»£ç :</strong> ${report.stock_code}</p>
                            <p><strong>å½“å‰ä»·æ ¼:</strong> Â¥${(report.price_info?.current_price || 0).toFixed(2)}</p>
                            <p><strong>æ¶¨è·Œå¹…:</strong> ${(report.price_info?.price_change || 0).toFixed(2)}%</p>
                        </div>

                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px;">
                            <h4 style="color: #495057; margin-bottom: 8px;">æŠ€æœ¯æŒ‡æ ‡</h4>
                            <p><strong>RSI:</strong> ${(report.technical_analysis?.rsi || 0).toFixed(1)}</p>
                            <p><strong>è¶‹åŠ¿:</strong> ${report.technical_analysis?.ma_trend || 'æœªçŸ¥'}</p>
                            <p><strong>MACD:</strong> ${report.technical_analysis?.macd_signal || 'æœªçŸ¥'}</p>
                        </div>

                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px;">
                            <h4 style="color: #495057; margin-bottom: 8px;">å¸‚åœºæƒ…ç»ª</h4>
                            <p><strong>æƒ…ç»ªè¶‹åŠ¿:</strong> ${report.sentiment_analysis?.sentiment_trend || 'ä¸­æ€§'}</p>
                            <p><strong>æ–°é—»æ•°é‡:</strong> ${report.sentiment_analysis?.total_analyzed || 0} æ¡</p>
                            <p><strong>ç½®ä¿¡åº¦:</strong> ${((report.sentiment_analysis?.confidence_score || 0) * 100).toFixed(1)}%</p>
                        </div>
                    </div>

                    <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; border-left: 4px solid #2196f3; margin-bottom: 24px;">
                        <h3 style="color: #1976d2; margin-bottom: 12px;">ğŸ¯ æŠ•èµ„å»ºè®®</h3>
                        <p style="font-size: 18px; font-weight: 600; color: #1976d2;">${report.recommendation || 'æ•°æ®ä¸è¶³'}</p>
                    </div>

                    <div style="background: #fff3e0; padding: 20px; border-radius: 8px; border-left: 4px solid #ff9800;">
                        <h3 style="color: #f57c00; margin-bottom: 12px;">ğŸ¤– AI æ·±åº¦åˆ†æ</h3>
                        <div style="color: #5d4037; font-size: 14px; line-height: 1.7;" class="ai-analysis-content">
                            ${aiAnalysisHtml}
                        </div>
                    </div>
                </div>
            `;

            resultsContent.innerHTML = html;
            document.getElementById('exportBtn').style.display = 'inline-flex';
        }

        function updateNonAIContent(report) {
            // æ›´æ–°éAIåˆ†æçš„å…¶ä»–å†…å®¹
            const resultsContent = document.getElementById('resultsContent');

            // æ›´æ–°æ ‡é¢˜
            const title = resultsContent.querySelector('h2');
            if (title) {
                title.innerHTML = `ğŸ“ˆ ${report.stock_name || report.stock_code} åˆ†ææŠ¥å‘Š <span style="font-size: 12px; color: #28a745; font-weight: normal;">âœ… æµå¼åˆ†æå®Œæˆ</span>`;
            }

            // æ›´æ–°åŸºæœ¬ä¿¡æ¯
            const basicInfoDiv = resultsContent.querySelector('div[style*="grid-template-columns"]');
            if (basicInfoDiv) {
                basicInfoDiv.innerHTML = `
                    <div style="background: #f8f9fa; padding: 16px; border-radius: 8px;">
                        <h4 style="color: #495057; margin-bottom: 8px;">åŸºæœ¬ä¿¡æ¯</h4>
                        <p><strong>è‚¡ç¥¨ä»£ç :</strong> ${report.stock_code}</p>
                        <p><strong>å½“å‰ä»·æ ¼:</strong> Â¥${(report.price_info?.current_price || 0).toFixed(2)}</p>
                        <p><strong>æ¶¨è·Œå¹…:</strong> ${(report.price_info?.price_change || 0).toFixed(2)}%</p>
                    </div>

                    <div style="background: #f8f9fa; padding: 16px; border-radius: 8px;">
                        <h4 style="color: #495057; margin-bottom: 8px;">æŠ€æœ¯æŒ‡æ ‡</h4>
                        <p><strong>RSI:</strong> ${(report.technical_analysis?.rsi || 0).toFixed(1)}</p>
                        <p><strong>è¶‹åŠ¿:</strong> ${report.technical_analysis?.ma_trend || 'æœªçŸ¥'}</p>
                        <p><strong>MACD:</strong> ${report.technical_analysis?.macd_signal || 'æœªçŸ¥'}</p>
                    </div>

                    <div style="background: #f8f9fa; padding: 16px; border-radius: 8px;">
                        <h4 style="color: #495057; margin-bottom: 8px;">å¸‚åœºæƒ…ç»ª</h4>
                        <p><strong>æƒ…ç»ªè¶‹åŠ¿:</strong> ${report.sentiment_analysis?.sentiment_trend || 'ä¸­æ€§'}</p>
                        <p><strong>æ–°é—»æ•°é‡:</strong> ${report.sentiment_analysis?.total_analyzed || 0} æ¡</p>
                        <p><strong>ç½®ä¿¡åº¦:</strong> ${((report.sentiment_analysis?.confidence_score || 0) * 100).toFixed(1)}%</p>
                    </div>
                `;
            }

            // æ›´æ–°æŠ•èµ„å»ºè®®
            const recommendationDiv = resultsContent.querySelector('div[style*="background: #e3f2fd"]');
            if (recommendationDiv) {
                const recommendationText = recommendationDiv.querySelector('p');
                if (recommendationText) {
                    recommendationText.textContent = report.recommendation || 'æ•°æ®ä¸è¶³';
                }
            }

            document.getElementById('exportBtn').style.display = 'inline-flex';
        }

        // ç®€å•çš„markdownè§£æå™¨ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        function simpleMarkdownParse(text) {
            if (!text) return '';

            return text
                .replace(/^### (.*$)/gim, '<h3 style="color: #2c3e50; margin: 16px 0 8px 0;">$1</h3>')
                .replace(/^## (.*$)/gim, '<h2 style="color: #2c3e50; margin: 20px 0 10px 0;">$1</h2>')
                .replace(/^# (.*$)/gim, '<h1 style="color: #2c3e50; margin: 24px 0 12px 0;">$1</h1>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code style="background: #f1f3f4; padding: 2px 4px; border-radius: 3px; font-family: monospace;">$1</code>')
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #1976d2;">$1</a>')
                .replace(/^[\-\*\+] (.*$)/gim, '<li style="margin: 4px 0;">$1</li>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
        }

        function displayBatchResults(reports) {
            if (!reports || reports.length === 0) {
                addLog('æ‰¹é‡åˆ†æç»“æœä¸ºç©º', 'warning');
                return;
            }

            const avgScores = {
                comprehensive: reports.reduce((sum, r) => sum + r.scores.comprehensive, 0) / reports.length,
                technical: reports.reduce((sum, r) => sum + r.scores.technical, 0) / reports.length,
                fundamental: reports.reduce((sum, r) => sum + r.scores.fundamental, 0) / reports.length,
                sentiment: reports.reduce((sum, r) => sum + r.scores.sentiment, 0) / reports.length
            };

            updateScoreCards(avgScores);

            const avgFinancial = reports.reduce((sum, r) => sum + (r.data_quality?.financial_indicators_count || 0), 0) / reports.length;
            const avgNews = reports.reduce((sum, r) => sum + (r.sentiment_analysis?.total_analyzed || 0), 0) / reports.length;

            document.getElementById('financialCount').textContent = Math.round(avgFinancial);
            document.getElementById('newsCount').textContent = Math.round(avgNews);
            document.getElementById('completeness').textContent = 'æ‰¹é‡';
            document.getElementById('dataQuality').style.display = 'grid';

            const resultsContent = document.getElementById('resultsContent');

            let tableRows = reports
                .sort((a, b) => b.scores.comprehensive - a.scores.comprehensive)
                .map((report, index) => `
                    <tr style="border-bottom: 1px solid #e9ecef;">
                        <td style="padding: 12px; font-weight: 600;">${index + 1}</td>
                        <td style="padding: 12px;">${report.stock_code}</td>
                        <td style="padding: 12px;">${report.stock_name || report.stock_code}</td>
                        <td style="padding: 12px; font-weight: 600; color: ${report.scores.comprehensive >= 70 ? '#27ae60' : report.scores.comprehensive >= 50 ? '#667eea' : '#e74c3c'};">
                            ${report.scores.comprehensive.toFixed(1)}
                        </td>
                        <td style="padding: 12px;">${report.scores.technical.toFixed(1)}</td>
                        <td style="padding: 12px;">${report.scores.fundamental.toFixed(1)}</td>
                        <td style="padding: 12px;">${report.scores.sentiment.toFixed(1)}</td>
                        <td style="padding: 12px; font-weight: 600;">${report.recommendation}</td>
                    </tr>
                `).join('');

            const html = `
                <div style="line-height: 1.6;">
                    <h2 style="color: #2c3e50; border-bottom: 2px solid #e9ecef; padding-bottom: 12px; margin-bottom: 20px;">
                        ğŸ“Š æ‰¹é‡åˆ†ææŠ¥å‘Š (${reports.length} åªè‚¡ç¥¨)
                        <span style="font-size: 12px; color: #28a745; font-weight: normal;">âœ… æµå¼åˆ†æå®Œæˆ</span>
                    </h2>

                    <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #495057; margin-bottom: 12px;">ğŸ“‹ åˆ†ææ±‡æ€»</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                            <div><strong>åˆ†ææ•°é‡:</strong> ${reports.length} åª</div>
                            <div><strong>å¹³å‡å¾—åˆ†:</strong> ${avgScores.comprehensive.toFixed(1)}</div>
                            <div><strong>ä¼˜ç§€è‚¡ç¥¨:</strong> ${reports.filter(r => r.scores.comprehensive >= 80).length} åª</div>
                            <div><strong>è‰¯å¥½è‚¡ç¥¨:</strong> ${reports.filter(r => r.scores.comprehensive >= 60).length} åª</div>
                        </div>
                    </div>

                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <th style="padding: 16px; text-align: left;">æ’å</th>
                                    <th style="padding: 16px; text-align: left;">ä»£ç </th>
                                    <th style="padding: 16px; text-align: left;">åç§°</th>
                                    <th style="padding: 16px; text-align: left;">ç»¼åˆå¾—åˆ†</th>
                                    <th style="padding: 16px; text-align: left;">æŠ€æœ¯é¢</th>
                                    <th style="padding: 16px; text-align: left;">åŸºæœ¬é¢</th>
                                    <th style="padding: 16px; text-align: left;">æƒ…ç»ªé¢</th>
                                    <th style="padding: 16px; text-align: left;">æŠ•èµ„å»ºè®®</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            resultsContent.innerHTML = html;
            document.getElementById('exportBtn').style.display = 'inline-flex';
        }

        function onAnalysisComplete(data) {
            isAnalyzing = false;
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('batchAnalyzeBtn').disabled = false;
            document.getElementById('systemStatus').className = 'status-indicator status-ready';
            document.getElementById('systemStatus').textContent = 'ç³»ç»Ÿå°±ç»ª';
            showProgress('singleProgress', false);
            showProgress('batchProgress', false);
            document.getElementById('currentStock').style.display = 'none';

            addLog('âœ… åˆ†æå®Œæˆ', 'success');
        }

        function onAnalysisError(data) {
            isAnalyzing = false;
            document.getElementById('analyzeBtn').disabled = false;
            document.getElementById('batchAnalyzeBtn').disabled = false;
            document.getElementById('systemStatus').className = 'status-indicator status-error';
            document.getElementById('systemStatus').textContent = 'åˆ†æå¤±è´¥';
            showProgress('singleProgress', false);
            showProgress('batchProgress', false);
            document.getElementById('currentStock').style.display = 'none';

            document.getElementById('resultsContent').innerHTML = `
                <div class="empty-state">
                    <h3>âŒ åˆ†æå¤±è´¥</h3>
                    <p>${data.error || 'æœªçŸ¥é”™è¯¯'}</p>
                </div>
            `;

            addLog(`âŒ åˆ†æå¤±è´¥: ${data.error}`, 'error');
        }

        // Analysis functions with SSE support
        async function analyzeSelectStock() {
            const strategy = document.getElementById('strategy').value.trim();
            if (!strategy) {
                addLog('è¯·è¾“å…¥ç­›é€‰ç­–ç•¥', 'warning');
                return;
            }
            const market = document.getElementById('market').value.trim();
            if (!market) {
                addLog('è¯·è¾“å…¥è‚¡ç¥¨å¸‚åœº', 'warning');
                return;
            }

            if (isAnalyzing) {
                addLog('åˆ†ææ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™', 'warning');
                return;
            }

            isAnalyzing = true;
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('systemStatus').className = 'status-indicator status-analyzing';
            document.getElementById('systemStatus').textContent = 'åˆ†æä¸­';

            addLog(`ğŸš€ å¼€å§‹æµå¼åˆ†æ${market}è‚¡çš„è‚¡ç¥¨:  ${stockCode}`, 'header');
            showLoading();
            showProgress('singleProgress');

            try {
                addLog(`ğŸš€ å¼€å§‹è®¿é—®${market}è‚¡çš„è‚¡ç¥¨:  ${stockCode}  åœ°å€: ${API_BASE}/api/select_stock`, 'header');
                const response = await fetch(`${API_BASE}/api/select_stock`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        strategy: strategy,
                        market: market,
                        enable_streaming: document.getElementById('enableStreaming').checked,
                        client_id: currentClientId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'åˆ†æå¤±è´¥');
                }

            } catch (error) {
                onAnalysisError({error: error.message});
            }
        }

        async function analyzeBatchStocks() {
            const stockListText = document.getElementById('stockList').value.trim();
            if (!stockListText) {
                addLog('è¯·è¾“å…¥è‚¡ç¥¨ä»£ç åˆ—è¡¨', 'warning');
                return;
            }
            const market = document.getElementById('market').value.trim();
            if (!market) {
                addLog('è¯·è¾“å…¥è‚¡ç¥¨å¸‚åœº', 'warning');
                return;
            }

            if (isAnalyzing) {
                addLog('åˆ†ææ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™', 'warning');
                return;
            }

            const stockList = stockListText.split('\n').map(s => s.trim()).filter(s => s);
            if (stockList.length === 0) {
                addLog('è‚¡ç¥¨ä»£ç åˆ—è¡¨ä¸ºç©º', 'warning');
                return;
            }

            isAnalyzing = true;
            document.getElementById('batchAnalyzeBtn').disabled = true;
            document.getElementById('systemStatus').className = 'status-indicator status-analyzing';
            document.getElementById('systemStatus').textContent = 'æ‰¹é‡åˆ†æä¸­';

            addLog(`ğŸ“Š å¼€å§‹æµå¼æ‰¹é‡åˆ†æ ${stockList.length} åªè‚¡ç¥¨`, 'header');
            showLoading();
            showProgress('batchProgress');
            document.getElementById('currentStock').style.display = 'block';

            try {
                const response = await fetch(`${API_BASE}/api/batch_analyze_stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        stock_codes: stockList,
                        client_id: currentClientId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'æ‰¹é‡åˆ†æå¤±è´¥');
                }

            } catch (error) {
                onAnalysisError({error: error.message});
            }
        }

        // Configuration
        function showConfig() {
            addLog('âš™ï¸ æ‰“å¼€é…ç½®å¯¹è¯æ¡†', 'info');

            fetch(`${API_BASE}/api/system_info`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const apis = data.data.configured_apis || [];
                        const versions = data.data.api_versions || {};
                        const primary = data.data.primary_api || 'openai';

                        let configInfo = `ğŸ”§  AIé…ç½®çŠ¶æ€

ğŸ¯ å½“å‰ç³»ç»ŸçŠ¶æ€ï¼š
âœ… åˆ†æå™¨ï¼šWebStockAnalyzer (SSEæµå¼ç‰ˆ)
âœ… é«˜å¹¶å‘ï¼š${data.data.max_workers}ä¸ªå·¥ä½œçº¿ç¨‹
âœ… æ´»è·ƒä»»åŠ¡ï¼š${data.data.active_tasks}ä¸ª
ğŸŒŠ æµå¼æ¨é€ï¼šSSE Server-Sent Events

ğŸ¤– AI APIé…ç½®çŠ¶æ€ï¼š`;

                        if (apis.length > 0) {
                            configInfo += `
âœ… å·²é…ç½®APIï¼š${apis.join(', ')}
ğŸ¯ ä¸»è¦APIï¼š${primary}

APIç‰ˆæœ¬è¯¦æƒ…ï¼š`;
                            apis.forEach(api => {
                                const version = versions[api] || 'æœªçŸ¥';
                                const status = version.includes('æœªå®‰è£…') ? 'âŒ' : 'âœ…';
                                configInfo += `
${status} ${api}: ${version}`;
                            });

                            configInfo += `

ğŸš€ AIåˆ†æåŠŸèƒ½ï¼šå®Œå…¨å¯ç”¨
âœ… æ·±åº¦è´¢åŠ¡åˆ†æ (25é¡¹æŒ‡æ ‡)
âœ… æŠ€æœ¯é¢ç²¾å‡†è§£è¯»
âœ… å¸‚åœºæƒ…ç»ªæŒ–æ˜
âœ… ç»¼åˆæŠ•èµ„ç­–ç•¥
âœ… é£é™©æœºä¼šè¯†åˆ«
ğŸŒŠ å®æ—¶æµå¼æ¨é€`;
                        } else {
                            configInfo += `
âš ï¸ æœªé…ç½®ä»»ä½•AI APIå¯†é’¥
ğŸ”§ å½“å‰ä½¿ç”¨ï¼šé«˜çº§è§„åˆ™åˆ†ææ¨¡å¼`;
                        }

                        configInfo += `

ğŸ“‹ é…ç½®æ–¹æ³•ï¼š
1. ç¼–è¾‘é¡¹ç›®ç›®å½•ä¸‹çš„ config.json æ–‡ä»¶
2. åœ¨ api_keys éƒ¨åˆ†å¡«å…¥æ‚¨çš„APIå¯†é’¥
3. é‡å¯æœåŠ¡å™¨ç”Ÿæ•ˆ

ğŸŒŸ æ¨èé…ç½®ï¼š
â€¢ OpenAI GPT-4o-mini (æ€§ä»·æ¯”é¦–é€‰)
â€¢ Claude-3-haiku (åˆ†æè´¨é‡ä¼˜ç§€)
â€¢ æ™ºè°±AI ChatGLM (å›½å†…ç½‘ç»œç¨³å®š)

ğŸ’¡ æ–°ç‰¹æ€§ï¼š
â€¢ ğŸŒŠ SSEå®æ—¶æµå¼æ¨é€
â€¢ ğŸ“Š å®æ—¶è¿›åº¦æ˜¾ç¤º
â€¢ ğŸ”„ åŠ¨æ€ç»“æœæ›´æ–°
â€¢ ğŸš€ æ›´ä½³ç”¨æˆ·ä½“éªŒ

ğŸ“ ç›¸å…³æ–‡ä»¶ï¼š
â€¢ é…ç½®æ–‡ä»¶ï¼šconfig.json
â€¢ åˆ†æå™¨ï¼šweb_stock_analyzer.py (ä¿®æ­£ç‰ˆ)
â€¢ æœåŠ¡å™¨ï¼šflask_web_server.py (SSEç‰ˆ)`;

                        alert(configInfo);
                    }
                })
                .catch(error => {
                    const fallbackInfo = `ğŸ”§  AIé…ç½®ç®¡ç†

âŒ æ— æ³•è·å–å½“å‰é…ç½®çŠ¶æ€ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥

ğŸ“‹ åŸºæœ¬é…ç½®æ–¹æ³•ï¼š
1. åœ¨é¡¹ç›®ç›®å½•åˆ›å»ºæˆ–ç¼–è¾‘ config.json
2. å¡«å…¥AI APIå¯†é’¥
3. é‡å¯æœåŠ¡å™¨

ğŸŒŠ æ–°ç‰¹æ€§ï¼šæ”¯æŒSSEå®æ—¶æµå¼æ¨é€

ğŸ’¡ å¦‚éœ€å¸®åŠ©ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—`;
                    alert(fallbackInfo);
                });
        }

        // Export report
        function exportReport() {
            if (!currentAnalysis) {
                addLog('âš ï¸ æ²¡æœ‰å¯å¯¼å‡ºçš„æŠ¥å‘Š', 'warning');
                return;
            }

            try {
                addLog('ğŸ“¤ å¼€å§‹å¯¼å‡ºåˆ†ææŠ¥å‘Š...', 'info');

                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                let content, filename, reportType;

                if (Array.isArray(currentAnalysis)) {
                    reportType = `æ‰¹é‡åˆ†æ(${currentAnalysis.length}åªè‚¡ç¥¨)`;
                    filename = `batch_analysis_sse_${timestamp}.md`;
                    content = generateBatchMarkdown(currentAnalysis);
                } else {
                    reportType = `å•ä¸ªè‚¡ç¥¨(${currentAnalysis.stock_code})`;
                    filename = `stock_analysis_sse_${currentAnalysis.stock_code}_${timestamp}.md`;
                    content = generateSingleMarkdown(currentAnalysis);
                }

                const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);

                addLog(`âœ… ${reportType}æŠ¥å‘Šå¯¼å‡ºæˆåŠŸ: ${filename}`, 'success');

                const fileSize = (content.length / 1024).toFixed(1);
                setTimeout(() => {
                    alert(`SSEæµå¼åˆ†ææŠ¥å‘Šå·²å¯¼å‡ºï¼\\n\\nğŸ“„ æ–‡ä»¶åï¼š${filename}\\nğŸ“Š æŠ¥å‘Šç±»å‹ï¼š${reportType}\\nğŸ“ æ–‡ä»¶å¤§å°ï¼š${fileSize} KB\\nğŸŒŠ åˆ†ææ–¹å¼ï¼šSSEå®æ—¶æµå¼æ¨é€\\nğŸ”§ åˆ†æå™¨ï¼šWeb v1.0 | WebStockAnalyzer`);
                }, 100);

            } catch (error) {
                const errorMsg = `å¯¼å‡ºå¤±è´¥ï¼š${error.message}`;
                addLog(`âŒ ${errorMsg}`, 'error');
                alert(errorMsg);
            }
        }

        function generateSingleMarkdown(report) {
            const aiAnalysis = report.ai_analysis || 'åˆ†ææ•°æ®å‡†å¤‡ä¸­...';

            return `# ğŸ“ˆ è‚¡ç¥¨åˆ†ææŠ¥å‘Š (Web V1.0)

## ğŸ¢ åŸºæœ¬ä¿¡æ¯
| é¡¹ç›® | å€¼ |
|------|-----|
| **è‚¡ç¥¨ä»£ç ** | ${report.stock_code} |
| **è‚¡ç¥¨åç§°** | ${report.stock_name} |
| **åˆ†ææ—¶é—´** | ${report.analysis_date} |
| **å½“å‰ä»·æ ¼** | Â¥${report.price_info.current_price.toFixed(2)} |
| **ä»·æ ¼å˜åŠ¨** | ${report.price_info.price_change.toFixed(2)}% |

## ğŸ“Š ç»¼åˆè¯„åˆ†

### ğŸ¯ æ€»ä½“è¯„åˆ†ï¼š${report.scores.comprehensive.toFixed(1)}/100

| ç»´åº¦ | å¾—åˆ† | è¯„çº§ |
|------|------|------|
| **æŠ€æœ¯åˆ†æ** | ${report.scores.technical.toFixed(1)}/100 | ${getScoreRating(report.scores.technical)} |
| **åŸºæœ¬é¢åˆ†æ** | ${report.scores.fundamental.toFixed(1)}/100 | ${getScoreRating(report.scores.fundamental)} |
| **æƒ…ç»ªåˆ†æ** | ${report.scores.sentiment.toFixed(1)}/100 | ${getScoreRating(report.scores.sentiment)} |

## ğŸ¯ æŠ•èµ„å»ºè®®

### ${report.recommendation}

## ğŸ¤– AIç»¼åˆåˆ†æ

${aiAnalysis}

---
*æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}*
*åˆ†æå™¨ç‰ˆæœ¬ï¼šWeb V1.0*
*åˆ†æå™¨ç±»ï¼šWebStockAnalyzer (SSEæµå¼ç‰ˆ)*
*æ¨é€æ–¹å¼ï¼šServer-Sent Events å®æ—¶æµå¼*
*æ•°æ®æ¥æºï¼šå¤šç»´åº¦ç»¼åˆåˆ†æ*
`;
        }

        function generateBatchMarkdown(reports) {
            let content = `# ğŸ“Š æ‰¹é‡è‚¡ç¥¨åˆ†ææŠ¥å‘Š - Web V1.0

**åˆ†ææ—¶é—´ï¼š** ${new Date().toLocaleString('zh-CN')}
**åˆ†ææ•°é‡ï¼š** ${reports.length} åªè‚¡ç¥¨
**åˆ†æå™¨ç‰ˆæœ¬ï¼š** Web V1.0
**åˆ†æå™¨ç±»ï¼š** WebStockAnalyzer (SSEæµå¼ç‰ˆ)
**æ¨é€æ–¹å¼ï¼š** Server-Sent Events å®æ—¶æµå¼

## ğŸ“‹ åˆ†ææ±‡æ€»

| æ’å | è‚¡ç¥¨ä»£ç  | è‚¡ç¥¨åç§° | ç»¼åˆå¾—åˆ† | æŠ€æœ¯é¢ | åŸºæœ¬é¢ | æƒ…ç»ªé¢ | æŠ•èµ„å»ºè®® |
|------|----------|----------|----------|--------|--------|--------|----------|
`;

            reports.sort((a, b) => b.scores.comprehensive - a.scores.comprehensive)
                   .forEach((report, index) => {
                content += `| ${index + 1} | ${report.stock_code} | ${report.stock_name} | ${report.scores.comprehensive.toFixed(1)} | ${report.scores.technical.toFixed(1)} | ${report.scores.fundamental.toFixed(1)} | ${report.scores.sentiment.toFixed(1)} | ${report.recommendation} |\n`;
            });

            content += `\n## ğŸ“ˆ è¯¦ç»†åˆ†æ\n\n`;

            reports.forEach(report => {
                content += generateSingleMarkdown(report);
                content += '\n---\n\n';
            });

            return content;
        }

        function getScoreRating(score) {
            if (score >= 80) return 'ä¼˜ç§€';
            if (score >= 60) return 'è‰¯å¥½';
            if (score >= 40) return 'ä¸€èˆ¬';
            return 'è¾ƒå·®';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ğŸš€ ç°ä»£è‚¡ç¥¨åˆ†æç³»ç»Ÿå·²å¯åŠ¨ (SSEæµå¼ç‰ˆ)', 'success');
            addLog('ğŸ“‹ Web V1.0 | WebStockAnalyzer (SSEç‰ˆ)', 'info');
            addLog('ğŸŒŠ SSEæµå¼æ¨é€ï¼šå®æ—¶è¿›åº¦æ˜¾ç¤º', 'info');
            addLog('ğŸ”¥ é«˜å¹¶å‘ä¼˜åŒ–ï¼šçº¿ç¨‹æ±  + å¼‚æ­¥å¤„ç† + ä»»åŠ¡é˜Ÿåˆ—', 'info');
            addLog('ğŸ¤– AIåˆ†æï¼šæ”¯æŒOpenAI/Claude/æ™ºè°±AIæ™ºèƒ½åˆ‡æ¢', 'info');
            addLog('ğŸ” å®‰å…¨ç‰¹æ€§ï¼šå¯†ç é‰´æƒ + ä¼šè¯ç®¡ç†', 'info');
            addLog('ğŸ’¡ æ”¯æŒè‚¡ç¥¨ä»£ç ï¼š000001, 600036, 300019ç­‰', 'info');

            // åˆå§‹åŒ–SSEè¿æ¥
            initSSE();

            // æ£€æŸ¥æœåŠ¡å™¨è¿æ¥å’Œç³»ç»Ÿä¿¡æ¯
            fetch(`${API_BASE}/api/system_info`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addLog('âœ… åç«¯æœåŠ¡å™¨è¿æ¥æˆåŠŸ', 'success');
                        addLog(`ğŸ”§ ç³»ç»ŸçŠ¶æ€ï¼š${data.data.active_tasks} ä¸ªæ´»è·ƒä»»åŠ¡`, 'info');
                        addLog(`ğŸ§µ çº¿ç¨‹æ± ï¼š${data.data.max_workers} ä¸ªå·¥ä½œçº¿ç¨‹`, 'info');

                        if (data.data.api_configured) {
                            const apis = data.data.configured_apis || [];
                            const versions = data.data.api_versions || {};
                            const primary = data.data.primary_api || 'openai';

                            addLog(`ğŸ¤– AI APIå·²é…ç½®: ${apis.join(', ')}`, 'success');
                            addLog(`ğŸ¯ ä¸»è¦API: ${primary}`, 'info');

                            apis.forEach(api => {
                                const version = versions[api] || '';
                                if (version) {
                                    addLog(`   - ${api}: ${version}`, 'info');
                                }
                            });

                            addLog('ğŸš€ æ”¯æŒå®Œæ•´AIæ·±åº¦åˆ†æ', 'success');
                        } else {
                            addLog('âš ï¸ æœªé…ç½®AI APIï¼Œå°†ä½¿ç”¨é«˜çº§è§„åˆ™åˆ†æ', 'warning');
                            addLog('ğŸ’¡ é…ç½®AI APIå¯†é’¥ä»¥è·å¾—æœ€ä½³åˆ†æä½“éªŒ', 'info');
                        }
                    }
                })
                .catch(error => {
                    addLog('âŒ åç«¯æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€', 'error');
                });
        });

        // é¡µé¢å¸è½½æ—¶å…³é—­SSEè¿æ¥
        window.addEventListener('beforeunload', function() {
            if (sseConnection) {
                sseConnection.close();
            }
        });
    </script>
</body>
</html>
